{% extends "base.html" %}
{% load static custom_filters %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">
    Predictions for tournament : {{ tournament.name }}
  </h1>

  <form method="post" class="space-y-8">
    {% csrf_token %}
    {% for matchday in matchdays %}
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">
           {{ matchday.date }} :
        </h2>

        {% for match in matchday.matches.all %}
          {% with prediction=predictions_by_match|get_item:match.id %}
            <div class="border-t pt-4 mt-4">
              <div class="flex items-center gap-4 mb-2">
                <!-- Logos team -->
                <img src="{{ match.red_team.logo.url }}" alt="{{ match.red_team.name }}" class="w-10 h-10 rounded-full object-cover border border-gray-300 shadow-sm">
                <span class="text-lg font-semibold text-gray-800">{{ match.red_team.name }}</span>
                <span class="text-gray-400 text-base mx-2">vs</span>
                <img src="{{ match.blue_team.logo.url }}" alt="{{ match.blue_team.name }}" class="w-10 h-10 rounded-full object-cover border border-gray-300 shadow-sm">
                <span class="text-lg font-semibold text-gray-800">{{ match.blue_team.name }}</span>
              </div>

              <!-- Winner Prediction -->
              <div class="flex gap-4 items-center mt-2">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="winner_{{ match.id }}" value="{{ match.red_team.id }}"
                    {% if prediction and prediction.predicted_winner.id == match.red_team.id %}checked{% endif %}>
                  {{ match.red_team.name }}
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="winner_{{ match.id }}" value="{{ match.blue_team.id }}"
                    {% if prediction and prediction.predicted_winner.id == match.blue_team.id %}checked{% endif %}>
                  {{ match.blue_team.name }}
                </label>
              </div>

              <!-- Nouvelle sélection de score -->
              <div class="mt-3">
                {% if match.possible_scores|length == 1 %}
                  <!-- BO1, pas de choix -->
                  <input type="hidden" name="score_{{ match.id }}" value="{{ match.possible_scores.0.0 }}-{{ match.possible_scores.0.1 }}">
                  <span class="text-gray-500 text-sm">Score unique ({{ match.possible_scores.0.0 }}-{{ match.possible_scores.0.1 }})</span>
                {% else %}
                  <label for="score_{{ match.id }}" class="block text-sm text-gray-600 mb-1">Score exact :</label>
                  <select name="score_{{ match.id }}" class="form-select mt-1 block w-full" required>
                    <option value="">-- Sélectionner un score --</option>
                    {% for winner, loser in match.possible_scores %}
                      {% with winner_str=winner|stringformat:"s" loser_str=loser|stringformat:"s" %}
                        {% with score_string=winner_str|add:" - "|add:loser_str %}
                          <option value="{{ score_string }}"
                            {% if prediction and prediction.predicted_score == score_string %}selected{% endif %}>
                            {{ score_string }}
                          </option>
                        {% endwith %}
                      {% endwith %}
                    {% endfor %}
                  </select>
                {% endif %}
              </div>
            </div>
          {% endwith %}
        {% endfor %}

        <!-- MVP -->
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Today MVP :
          </label>
          {% with selected_mvp=fantasy_by_day|get_item:matchday.id %}
            <select name="fantasy_{{ matchday.id }}" class="form-select w-full" required>
              <option value="">-- Pick a player --</option>
              {% for match in matchday.matches.all %}
                {% if match.red_team.player_set.all %}
                  <optgroup label="{{ match.red_team.name }}">
                    {% for player in match.red_team.player_set.all %}
                      <option value="{{ player.id }}"
                        {% if selected_mvp and selected_mvp.id == player.id %}selected{% endif %}>
                        {{ player.name }}
                      </option>
                    {% endfor %}
                  </optgroup>
                {% endif %}
                {% if match.blue_team.player_set.all %}
                  <optgroup label="{{ match.blue_team.name }}">
                    {% for player in match.blue_team.player_set.all %}
                      <option value="{{ player.id }}"
                        {% if selected_mvp and selected_mvp.id == player.id %}selected{% endif %}>
                        {{ player.name }}
                      </option>
                    {% endfor %}
                  </optgroup>
                {% endif %}
              {% endfor %}
            </select>
          {% endwith %}
        </div>
      </div>
    {% endfor %}

    <div class="text-center">
      {% if predictions_by_match %}
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-xl shadow">
          Change Predictions
        </button>
      {% else %}
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-xl shadow">
          Save Predictions
        </button>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}
